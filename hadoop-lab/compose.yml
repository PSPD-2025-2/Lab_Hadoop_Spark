services:
  nn:
    build: .
    container_name: hadoop-nn
    hostname: nn
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
      - ./data/namenode:/home/hadoop/data/namenode
    ports:
      - "9870:9870"   # NameNode UI
      - "9000:9000"   # fs.defaultFS
    command: >
      bash -lc "
        if [ ! -f /home/hadoop/data/namenode/current/VERSION ]; then
          echo '>> Formatting HDFS (first run)...';
          $$HADOOP_HOME/bin/hdfs namenode -format -force -nonInteractive;
        fi &&
        $$HADOOP_HOME/bin/hdfs --daemon start namenode &&
        # espere o arquivo de log aparecer (evita erro do tail) e só então 'tail -f';
        for i in {1..30}; do ls $$HADOOP_HOME/logs/*namenode* >/dev/null 2>&1 && break || sleep 1; done;
        tail -f $$HADOOP_HOME/logs/*namenode*.log || sleep infinity
      "



  dn1:
    build: .
    container_name: hadoop-dn1
    hostname: dn1
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
      - ./data/datanode1:/home/hadoop/data/datanode
    depends_on: [nn]
    ports:
      - "9864:9864"   # DataNode UI (dn1)
    command: >
      bash -lc "
        $$HADOOP_HOME/bin/hdfs --daemon start datanode &&
        tail -f $$HADOOP_HOME/logs/*datanode*.log
      "

  dn2:
    build: .
    container_name: hadoop-dn2
    hostname: dn2
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
      - ./data/datanode2:/home/hadoop/data/datanode
    depends_on: [nn]
    command: >
      bash -lc "
        $$HADOOP_HOME/bin/hdfs --daemon start datanode &&
        tail -f $$HADOOP_HOME/logs/*datanode*.log
      "

  rm:
    build: .
    container_name: hadoop-rm
    hostname: rm
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
    depends_on: [nn, dn1, dn2]
    ports:
      - "8088:8088"   # YARN ResourceManager UI
    command: >
      bash -lc "
        $$YARN_HOME/bin/yarn --daemon start resourcemanager &&
        tail -f $$HADOOP_HOME/logs/*resourcemanager*.log
      "

  nm1:
    build: .
    container_name: hadoop-nm1
    hostname: nm1
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
    depends_on: [rm]
    command: >
      bash -lc "
        $$YARN_HOME/bin/yarn --daemon start nodemanager &&
        tail -f $$HADOOP_HOME/logs/*nodemanager*.log
      "

  nm2:
    build: .
    container_name: hadoop-nm2
    hostname: nm2
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
    depends_on: [rm]
    command: >
      bash -lc "
        $$YARN_HOME/bin/yarn --daemon start nodemanager &&
        tail -f $$HADOOP_HOME/logs/*nodemanager*.log
      "

  jhs:
    build: .
    container_name: hadoop-jhs
    hostname: jhs
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
    depends_on: [rm]
    ports:
      - "19888:19888" # JobHistory UI
    command: >
      bash -lc "
        $$HADOOP_HOME/bin/mapred --daemon start historyserver &&
        tail -f $$HADOOP_HOME/logs/*historyserver*.log
      "

  edge:
    build: .
    container_name: hadoop-edge
    hostname: edge
    stdin_open: true
    tty: true
    volumes:
      - ./config/core-site.xml:/home/hadoop/hadoop/etc/hadoop/core-site.xml:ro
      - ./config/hdfs-site.xml:/home/hadoop/hadoop/etc/hadoop/hdfs-site.xml:ro
      - ./config/yarn-site.xml:/home/hadoop/hadoop/etc/hadoop/yarn-site.xml:ro
      - ./config/mapred-site.xml:/home/hadoop/hadoop/etc/hadoop/mapred-site.xml:ro
      - ./config/workers:/home/hadoop/hadoop/etc/hadoop/workers:ro
      # (apenas se você criou esse arquivo)
      - ./config/hadoop-env.sh:/home/hadoop/hadoop/etc/hadoop/hadoop-env.sh:ro
      - ./jobs:/home/hadoop/jobs
    depends_on: [nn, rm]
    command: bash
